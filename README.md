# Boogie Square

A collaborative video grid application where users contribute dance videos to create synchronized 4x4 grids. Built with React, AWS Amplify, and optimized for both desktop and mobile devices.

## Overview

Boogie Square is an interactive web application that allows multiple users to contribute short dance videos to fill a 16-slot grid (4x4). Each user can record three "takes" for their assigned slot, and the grid automatically cycles through these takes in synchronized playback. The application supports multiple grids, allowing new grids to be created as previous ones are completed.

## Features

### Core Functionality
- **4x4 Video Grid**: 16 slots for collaborative video contributions
- **Multi-Take Recording**: Each user records 3 takes per slot for variety
- **Synchronized Playback**: All videos play in sync, cycling through takes every 4 seconds
- **Multiple Grids**: Automatic grid creation when current grid is full
- **Grid Navigation**: Browse between different completed grids

### User Experience
- **Google OAuth Authentication**: Sign in with Google for persistent identity
- **Anonymous Mode**: Fallback support for users without authentication
- **Tutorial Videos**: Visual guides for each slot position
- **Mobile Optimized**: Performance optimizations for mobile devices
- **Real-time Sync**: Updates from other users appear automatically

### Technical Features
- **AWS S3 Storage**: Secure video storage with private access controls
- **Cross-User Sharing**: Shared grid state via S3 public storage
- **Mobile Performance**: Optimized video loading and playback for mobile
- **Responsive Design**: Works seamlessly on desktop and mobile devices

## Architecture

### Frontend
- **React 18** with Vite for fast development
- **React Router** for navigation
- **Context API** for state management (`VideoContext`)
- **Tailwind CSS** for styling
- **AWS Amplify UI** for authentication

### Backend (AWS Amplify)
- **Authentication**: AWS Cognito with Google OAuth
- **Storage**: S3 buckets for video and metadata storage
  - `private/*`: User-uploaded videos (identity-scoped)
  - `public/*`: Shared grid metadata (JSON files)
- **Data**: GraphQL API (optional, for future features)

### Data Structure
- **Grid Metadata**: Stored in S3 as JSON files
  - `shared-boogie-grid-{N}.json`: Video references for grid N
  - `shared-boogie-takes-{N}.json`: Three takes per slot for grid N
  - `shared-boogie-contributions-{N}.json`: User contribution records
  - `shared-boogie-active-grid-number.json`: Current active grid number
  - `shared-boogie-user-grid-mapping.json`: User-to-grid mapping

## Prerequisites

- **Node.js** 18+ and npm
- **AWS Account** with Amplify CLI configured
- **Google OAuth Credentials** (see [Google Auth Setup](./GOOGLE_AUTH_SETUP.md))
- **Git** for version control

## Installation

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd boogie_square_basic
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure AWS Amplify**
   ```bash
   npx ampx sandbox
   ```
   This will:
   - Deploy the Amplify backend (Auth, Storage, Data)
   - Generate `amplify_outputs.json` configuration file
   - Set up required AWS resources

4. **Set up Google OAuth secrets**
   ```bash
   npx ampx sandbox secret set GOOGLE_CLIENT_ID
   npx ampx sandbox secret set GOOGLE_CLIENT_SECRET
   ```
   Enter your Google OAuth credentials when prompted. See [GOOGLE_AUTH_SETUP.md](./GOOGLE_AUTH_SETUP.md) for detailed instructions.

5. **Verify configuration**
   - Ensure `amplify_outputs.json` exists in the root directory
   - Check that it contains valid AWS configuration

## Configuration

### Environment Variables
The app uses `amplify_outputs.json` generated by Amplify. No manual environment variables needed.

### Google OAuth Setup
1. Create OAuth credentials in [Google Cloud Console](https://console.cloud.google.com/)
2. Add authorized origins:
   - `http://localhost:5173` (development)
   - Your production domain
3. Add authorized redirect URIs (same as origins)
4. Store credentials as Amplify secrets (see Installation step 4)

### Storage Configuration
Storage buckets are automatically created by Amplify. Access patterns:
- **Public**: Grid metadata (readable by all, writable by authenticated users)
- **Protected**: Future feature storage
- **Private**: User videos (only accessible by uploader)

## Development

### Start Development Server
```bash
npm run dev
```
The app will be available at `http://localhost:5173`

### Build for Production
```bash
npm run build
```
Output will be in the `dist/` directory.

### Preview Production Build
```bash
npm run preview
```

### Project Structure
```
boogie_square_basic/
├── amplify/              # AWS Amplify backend configuration
│   ├── auth/            # Authentication setup
│   ├── storage/         # S3 storage configuration
│   ├── data/            # GraphQL API schema
│   └── backend.ts       # Backend definition
├── public/              # Static assets
│   ├── music/          # Background music files
│   └── tutorial_*/     # Tutorial video patterns
├── src/
│   ├── components/     # React components
│   ├── context/        # VideoContext for state management
│   ├── pages/          # Main application pages
│   │   ├── MainGrid.jsx    # Main grid view
│   │   ├── RecordPage.jsx   # Video recording page
│   │   └── TrainPage.jsx    # Training/tutorial page
│   ├── router/         # React Router setup
│   └── main.jsx        # Application entry point
├── amplify_outputs.json # Generated Amplify configuration
└── package.json        # Dependencies and scripts
```

## Performance Optimizations

### Desktop
- **3 Video Elements per Slot**: All takes preloaded for instant switching
- **500ms Sync Interval**: Keeps videos synchronized
- **Just-in-Time Preloading**: Next take loads 1.5s before switch

### Mobile
- **2 Video Elements per Slot**: Current + next take only (reduces memory by 67%)
- **1s Sync Interval**: Less frequent syncing to save CPU
- **Tutorial Videos Disabled**: Saves 16 video streams
- **Delayed Preloading**: Next take loads 2.5s before switch
- **Opacity Swapping**: Instant transitions without rebuffering

### Video Loading Strategy
1. **Staged Loading**: Only load visible take initially
2. **Progressive Enhancement**: Load next take before switch
3. **Caching**: URLs cached to avoid redundant S3 requests
4. **Lazy Tutorials**: Tutorial videos only on desktop

## Deployment

### Deploy with AWS Amplify Hosting

1. **Connect Repository**
   - Go to AWS Amplify Console
   - Connect your Git repository
   - Select the branch to deploy

2. **Configure Build Settings**
   ```yaml
   version: 1
   frontend:
     phases:
       preBuild:
         commands:
           - npm ci
       build:
         commands:
           - npm run build
     artifacts:
       baseDirectory: dist
       files:
         - '**/*'
     cache:
       paths:
         - node_modules/**/*
   ```

3. **Set Environment Variables**
   - No environment variables needed (uses `amplify_outputs.json`)

4. **Deploy**
   - Amplify will automatically deploy on push to connected branch

### Manual Deployment

1. **Build the application**
   ```bash
   npm run build
   ```

2. **Deploy `dist/` directory**
   - Upload to your hosting provider (Netlify, Vercel, etc.)
   - Ensure `amplify_outputs.json` is included in the build

## Security

### Video Privacy
- User-uploaded videos stored in `private/*` path
- Only the uploader (via Cognito Identity ID) can access their videos
- Grid metadata is public for cross-user collaboration

### Authentication
- Google OAuth for secure sign-in
- Anonymous fallback for testing
- AWS Cognito manages user sessions

### Access Control
- Storage bucket policies enforce access rules
- Pre-signed URLs for video playback
- Public metadata, private videos

## Troubleshooting

### Videos Not Loading
- Check `amplify_outputs.json` exists and is valid
- Verify S3 bucket permissions
- Check browser console for CORS errors

### Authentication Issues
- Verify Google OAuth credentials are set correctly
- Check callback URLs match in Google Console
- Ensure Amplify secrets are set: `npx ampx sandbox secret list`

### Mobile Performance
- If lag persists, reduce number of filled slots for testing
- Check device memory constraints
- Verify videos are properly optimized

### Grid Not Syncing
- Check S3 public storage permissions
- Verify `shared-boogie-*` files exist in S3
- Check browser console for sync errors

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is private and proprietary.

## Acknowledgments

- Built with [AWS Amplify](https://aws.amazon.com/amplify/)
- UI components from [shadcn/ui](https://ui.shadcn.com/)
- Video processing with [FFmpeg.wasm](https://ffmpegwasm.netlify.app/)

## Support

For issues and questions, please open an issue in the repository or contact the development team.

---

**Note**: This application requires AWS resources and will incur AWS costs based on usage (S3 storage, data transfer, Cognito authentication). Monitor your AWS billing dashboard regularly.

